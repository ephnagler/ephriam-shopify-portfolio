---
import JumboText from "../components/JumboText.astro";
import Connect from "../components/Connect.astro";
import "../styles/global.css";
import { ClientRouter } from "astro:transitions";

import posthog from "posthog-js";

// Only initialize PostHog if API key is available and not in development
if (import.meta.env.PUBLIC_POSTHOG_API_KEY && !import.meta.env.DEV) {
  posthog.init(import.meta.env.PUBLIC_POSTHOG_API_KEY, {
    api_host: import.meta.env.PUBLIC_POSTHOG_HOST || "https://us.i.posthog.com",
    defaults: "2025-05-24",
    // Enable autocapture for better event tracking
    autocapture: true,
    // Enable session recording
    session_recording: {
      recordCrossOriginIframes: false,
    },
    // Enable feature flags
    advanced_disable_decide: false,
    // Enable surveys (available in newer versions)
    // surveys: true,
    // Enable error tracking
    capture_exceptions: true,
    // Enable web vitals tracking (available in newer versions)
    // web_vitals: true,
  });
}
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <!-- <link rel="icon" type="image/svg+xml" href="/favicon.svg" /> -->
    <meta name="generator" content={Astro.generator} />
    <title>Ephriam Nagler â€“ Shopify Expert</title>

    <!-- Preconnect to local fonts for faster loading -->
    <link rel="preconnect" href="/fonts/" />
    <link rel="dns-prefetch" href="/fonts/" />

    <ClientRouter />

    <!-- PostHog tracking script for Astro view transitions -->
    <script>
      // Wait for PostHog to be ready
      function trackPageView() {
        if (typeof window !== "undefined" && (window as any).posthog) {
          (window as any).posthog.capture("$pageview", {
            $current_url: window.location.href,
            $pathname: window.location.pathname,
            $title: document.title,
          });
        }
      }

      // Track page views with Astro's view transitions
      document.addEventListener("astro:page-load", trackPageView);

      // Track initial page load (with a small delay to ensure PostHog is ready)
      setTimeout(trackPageView, 100);
    </script>

    <!-- Unified animation system -->
    <script>
      let animationObserver = null;

      // Unified intersection observer for all animations
      function setupUnifiedAnimations() {
        // Clean up existing observer
        if (animationObserver) {
          animationObserver.disconnect();
        }

        const observerOptions = {
          threshold: 0.3,
          rootMargin: "0px 0px -50px 0px",
        };

        animationObserver = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const element = entry.target;
              const animationType = element.dataset.animationType;

              if (animationType === "line") {
                element.classList.add("animate-line");
              } else if (animationType === "content") {
                element.classList.add("animate-visible");
              }

              // Unobserve after animation
              animationObserver?.unobserve(element);
            }
          });
        }, observerOptions);

        // Observe elements with animation data attributes
        const animatedElements = document.querySelectorAll(
          "[data-animation-type]"
        );
        animatedElements.forEach((element) => {
          animationObserver?.observe(element);
        });
      }

      // Setup on page load and view transitions
      document.addEventListener("astro:page-load", setupUnifiedAnimations);
      setTimeout(setupUnifiedAnimations, 100); // Initial load
    </script>
  </head>
  <body>
    {
      Astro.url.pathname === "/" ? (
        <JumboText text="Ephriam Nagler" class="title" />
      ) : (
        <a href="/">
          <div class="md:hidden">
            <JumboText text="Ephriam Nagler" class="title" />
          </div>
          <h1 class="hidden md:block hover:text-[var(--color-text)] transition-colors duration-300 font-serif text-[var(--color-accent)] tracking-tight text-4xl md:fixed top-4 left-4">
            Ephriam Nagler
          </h1>
        </a>
      )
    }

    <div class="flex flex-col gap-4 m-2 md:m-0">
      <slot />
      <Connect />
    </div>
  </body>
</html>
